# Flow State (心境) 项目技术复盘报告

## 1. 项目功能概述
Flow State 是一个智能化的深度专注力辅助工具，旨在帮助用户量化心流状态、识别注意力模式并提供实时反馈。项目核心理念是将无形的“专注力”转化为可视化的数据指标，通过 AI 语义分析与非侵入式的 UI 设计，引导用户进入并维持心流状态。

**核心功能模块：**
*   **全景行为捕捉**：实时监控用户当前活跃窗口与进程，精准记录每一秒的数字足迹。
*   **AI 语义识别**：利用大模型（LLM）深度理解用户当前活动内容（如区分“在B站看教程”与“在B站看娱乐视频”），而非简单的关键词匹配。
*   **多维量化指标**：独创“意志力胜利”、“效能指数”、“碎片率”等高阶指标，全方位评估工作质量。
*   **沉浸式交互**：
    *   **悬浮球 (Float Ball)**：以颜色（绿/黄/红）动态映射当前状态，极简且不打扰。
    *   **专注卡片 (Focus Card)**：悬浮球交互后的详细面板，展示当前任务、持续时长与状态摘要。
    *   **智能干预**：当检测到长时间娱乐或过度疲劳时，触发柔性提醒（Fatigue/Entertainment Reminder）。
*   **深度复盘报告**：
    *   **每日概览**：可视化时间轴回顾全天活动。
    *   **数据洞察**：AI 生成的每日金句与核心成就总结。

---

## 2. 技术架构与实现方案

### 2.1 技术栈
*   **语言**：Python 3.10+
*   **GUI 框架**：PySide6 (Qt for Python) - 用于构建高性能、美观的桌面客户端。
*   **数据存储**：SQLite3 - 采用分库策略 (`focus_app.db`, `period_stats.db`, `core_events.db`) 确保高并发下的读写稳定性。
*   **AI 引擎**：Langflow - 作为 LLM 的编排层，支持本地模型（Ollama等）或云端模型接入，实现低延迟的语义分析。
*   **Web 服务**：Flask - 提供本地 API 接口，支持 Web 视图渲染与图表数据服务。
*   **并发模型**：`multiprocessing` - 将监控服务 (`monitor_service.py`) 与 UI 主进程分离，确保界面流畅不卡顿。

### 2.2 核心模块设计

#### A. 监控与识别层 (Monitor & Detector)
*   **Monitor Service (`monitor_service.py`)**：作为后台守护进程，以 1秒/次 的频率轮询系统窗口。采用“去抖动”策略（只有窗口停留 >5秒 才触发分析），有效过滤快速切换带来的噪声。
*   **Detector Logic (`detector_logic.py`)**：AI 分析的入口。它将窗口标题、进程名封装为 Prompt，通过 `LangflowClient` 发送给 LLM。
*   **Langflow Integration**：利用 Langflow 的流式处理能力，将非结构化的窗口标题转化为结构化的 JSON 数据（状态分类 + 简短摘要）。

#### B. 数据持久化层 (Data Access)
*   **数据库拆分策略**：
    *   `focus_app.db`：存储原始日志 (`activity_logs`) 和基础会话 (`window_sessions`)，高频写入。
    *   `core_events.db`：存储经 AI 聚合后的每日核心事件 (`core_events`)，用于生成日报摘要。
    *   `period_stats.db`：存储计算后的高阶指标 (`period_stats`)，用于趋势分析。
*   **DAO 模式**：通过 `ActivityDAO`, `StatsDAO` 等类封装 SQL 操作，实现业务逻辑与数据访问解耦。

#### C. UI 交互层 (Views & Widgets)
*   **悬浮球 (`float_ball.py`)**：实现无边框悬浮窗，支持拖拽、边缘吸附与鼠标穿透检测。
*   **动态渲染 (`daily.py`)**：使用 PySide6 的 Layout 系统构建响应式布局，自定义 `paintEvent` 实现时间轴与统计图表的绘制。

---

## 3. 核心算法思路

### 3.1 意志力胜利 (Willpower Wins)
这是一个游戏化的指标，用于量化用户“从分心中找回专注”的能力。
*   **状态机模型**：
    *   `State 0 (Seek Focus)`: 寻找专注（专注时长 > 5分钟）。
    *   `State 1 (In Focus)`: 处于专注状态，等待分心。
    *   `State 2 (Recovery)`: 发生短暂分心（< 5分钟）并迅速切回专注（> 5分钟）。
*   **判定逻辑**：只有完成 `专注 -> 短暂分心 -> 专注` 的完整闭环，计数器 +1。这比单纯记录“专注时长”更能体现用户的主动控制力。

### 3.2 效能指数 (Efficiency Score)
一个 0-100 的综合评分，动态反映当前的工作状态质量。
*   **公式**：`Score = Base(60) + (FocusHours * 5) + (WillpowerWins * 2)`
*   **上限**：100分。
*   **设计意图**：基础分保证挫败感不至于太强，时长奖励勤奋，意志力奖励自控，鼓励用户不仅要“坐得住”，还要“拉得回”。

### 3.3 专注/碎片比 (Fragmentation Ratio)
衡量注意力的连续性。
*   **公式**：`Ratio = 平均专注会话时长 / 平均娱乐会话时长`
*   **解读**：
    *   `> 1.2`：深度心流态（专注段长，娱乐段短）。
    *   `< 0.8`：碎片化焦虑（频繁被打断，无法深入）。

### 3.4 核心事件提取 (Core Events Extraction)
如何从成百上千条琐碎的窗口记录中提取出“今天到底干了什么”？
*   **漏斗筛选法 (`core_events_extractor.py`)**：
    1.  **硬过滤**：剔除 < 30秒 的瞬时窗口。
    2.  **语义聚合**：利用 AI 识别同一任务的不同窗口标题（如 "文档-第一章" 和 "文档-第二章" 聚合为 "编辑文档"）。
    3.  **Top-N 排序**：分别选取时长最长的 Top 3 工作项与 Top 2 娱乐项。
    4.  **混合输出**：生成如 “编写后端代码，调试脚本，看B站” 这样的自然语言摘要。

---

## 4. 创意方案亮点

1.  **“意志力胜利”的游戏化激励**：
    大多数工具只惩罚“分心”，而 Flow State 奖励“回归”。这在心理学上给予用户积极的正反馈，让“拉回注意力”这一痛苦过程变成一种获得成就感的行为。

2.  **AI 驱动的“真”语义理解**：
    区别于传统的“黑白名单”机制（如只能机械地将 chrome.exe 设为娱乐），本项目通过 LLM 理解上下文。如果你在 Chrome 里看 GitHub，它是“工作”；如果你在 Chrome 里看 Netflix，它是“娱乐”。这种动态判定极大地提升了统计的准确性。

3.  **零干扰的“心流”设计哲学**：
    UI 设计极致克制。默认状态下只有一个呼吸灯般的悬浮球，颜色随状态缓慢渐变。没有弹窗轰炸，没有强制锁屏。它像一个安静的观察者，只在用户真正需要（如极度疲劳或查看状态）时才显现。

4.  **本地化与隐私安全**：
    所有数据存储在本地 SQLite，AI 模型支持接入本地 Ollama/Langflow。用户的屏幕活动隐私完全掌握在自己手中，无需上传云端。

5.  **数据可视化的叙事性**：
    日报不仅仅是图表，更是一份“叙事”。通过时间轴复现一天的轨迹，配合 AI 生成的“每日金句”与“致追梦者”评语，让枯燥的数据变得有温度，帮助用户建立与自我对话的反馈回路。
